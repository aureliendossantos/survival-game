generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id         String      @id @default(cuid())
  name       String
  email      String?     @unique
  createdAt  DateTime    @default(now())
  characters Character[]
}

model Character {
  id              String           @id @default(cuid())
  name            String
  userId          String
  mapId           Int              @default(1)
  x               Int              @default(1)
  y               Int              @default(1)
  map             Map              @relation(fields: [mapId], references: [id])
  cell            Cell             @relation(fields: [mapId, x, y], references: [mapId, x, y])
  user            User             @relation(fields: [userId], references: [id])
  inventory       Inventory[]
  builtStructures BuiltStructure[]
}

model Item {
  id          Int             @id @default(autoincrement())
  description String?
  title       String
  inAction    ActionLoot[]
  inInventory Inventory[]
  inStructure StructureCost[]
}

model Inventory {
  characterId String
  itemId      Int
  quantity    Int       @default(0)
  character   Character @relation(fields: [characterId], references: [id])
  item        Item      @relation(fields: [itemId], references: [id])

  @@unique([characterId, itemId])
}

model Map {
  id         Int         @id @default(autoincrement())
  cells      Cell[]
  characters Character[]
}

model Cell {
  id              String           @id @default(cuid())
  mapId           Int
  x               Int
  y               Int
  terrainId       String           @default("plains")
  builtStructures BuiltStructure[]
  map             Map              @relation(fields: [mapId], references: [id])
  terrain         Terrain          @relation(fields: [terrainId], references: [id])
  characters      Character[]

  @@unique([mapId, x, y])
}

model Terrain {
  description String?
  id          String   @id
  title       String   @default("Plaines")
  cells       Cell[]
  actions     Action[]
}

model BuiltStructure {
  id                String      @id @default(cuid())
  durability        Int
  lastDurabilitySet DateTime    @default(now())
  cellId            String
  structureId       Int
  cell              Cell        @relation(fields: [cellId], references: [id])
  structure         Structure   @relation(fields: [structureId], references: [id])
  contributors      Character[]
}

model Structure {
  title             String
  description       String?
  minDurability     Int              @default(100)
  maxDurability     Int              @default(100)
  id                Int              @id @default(autoincrement())
  upgradeOf         Int?
  builtStructures   BuiltStructure[]
  parentStructure   Structure?       @relation("Upgrades", fields: [upgradeOf], references: [id])
  availableUpgrades Structure[]      @relation("Upgrades")
  requiredItems     StructureCost[]
}

model StructureCost {
  itemId      Int
  quantity    Int       @default(0)
  structureId Int
  item        Item      @relation(fields: [itemId], references: [id])
  structure   Structure @relation(fields: [structureId], references: [id])

  @@unique([structureId, itemId])
}

model Action {
  title          String
  description    String?
  probability    Int          @default(100)
  successMessage String       @default("Vous avez trouvé $1 unités.")
  failureMessage String?      @default("Vous n'avez rien trouvé.")
  id             Int          @id @default(autoincrement())
  loot           ActionLoot[]
  terrains       Terrain[]
}

model ActionLoot {
  itemId      Int
  minQuantity Int?   @default(0)
  maxQuantity Int?   @default(0)
  actionId    Int
  action      Action @relation(fields: [actionId], references: [id])
  item        Item   @relation(fields: [itemId], references: [id])

  @@unique([actionId, itemId])
}
